pipeline {
    agent any
    environment {
        dockerImageName = 'django_from_jenkins'
    }
    stages {
        stage('Build') {
            steps {
                echo 'Building the Docker image'
                dir('django_web_app') {
                    sh 'docker build -t django_from_jenkins .'
                }
            }
        }

        stage('Testing the app') {
            steps {
                echo 'Running Django tests'
                dir('django_web_app') {
                    sh 'docker run -p 8001:8000 --name django_from_jenkinss_container django_from_jenkins '
                    script {
                     // Set the URL to be tested
                    def url = "http://localhost:8001/"

                    // Perform the cURL request and store the HTTP status code in a variable
                    def httpStatus = sh(script: "curl -s -o /dev/null -w \"%{http_code}\" $url", returnStatus: true).trim().toInteger()

                    // Check if the status code is 200 (OK)
                    if (httpStatus == 200) {
                        echo "Success! HTTP Status Code: $httpStatus"
                    } else {
                        error "Failed! HTTP Status Code: $httpStatus"
                        }
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                echo 'Deploying...'
                // Add deployment steps here
            }
        }
    }

    post {
        success {
            echo 'Pipeline succeeded! Send notifications or perform additional tasks here.'
        }
        failure {
            echo 'Pipeline failed! Send notifications or perform cleanup tasks here.'
        }
    }
}
